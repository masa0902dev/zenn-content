---
title: "計算統計物理学を学んでみよう【学部向け】"
emoji: "🗺️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["研究", "計算統計物理学", "分子シミュレーション"]
published: false
---

# はじめに
## これは何？
学部生が研究のために「計算統計物理学」を学んだノートです。
この領域に興味を持つ人が増えるといいなぁと思い、ノートを公開しています。

:::message alert
CAUTION:

1. 他の分野や文脈においては、用語等の意味合いが違う場合もあります。
2. 私の知識不足により誤りを含む可能性があります。
:::

:::details 個人的な Zenn メモ

TODO: 私が後でやるべきこと
ASK: 私が後で聞くべきこと
RES: 私が後で考えてみたりシミュレートしてみたいこと

- Zenn での数式の参考 (Zenn は$\KaTeX$が使える):

  - `npx zenn preview`で見れば良い。
  - ⭕️: $a=10$, ❌: $ a=10 $ (インラインは空白ダメ)
  - 数式ブロックは、上を1行空ける必要あり。
  - [Zenn で数式を書く方法](https://zenn.dev/dmiyamo3/articles/34fb48a88aa813beffc0)
  - [Zenn で数式を表示する](https://zenn.dev/ykyki/articles/math-formulae-in-zenn)

- Zenn での目次は、heading2 まで表示される。
- [Zenn の Markdown 記法一覧](https://zenn.dev/zenn/articles/markdown-guide)
:::

## キーワード
- computational statistical physics (csp)
- hard disk / sphere model (剛体円盤/球モデル)
- Event-Chain Monte Carlo (ECMC), Newtonian Event-Chain (NEC)
- Event-Driven Molecular Dynamics (EDMD)
- 統計力学
- structural relaxation (構造緩和)
- 分子シミュレーション

# 計算統計物理学ノート
## 一般
固体：分子の位置に規則性（位置秩序）を持つものは結晶と呼ぶ。
剛体球系における融解や結晶化などの相転移は、統計物理学において重要な問題。

状態量が時間的に変化している場合が非平衡状態。非平衡 → 平衡という移行を緩和や平衡緩和と呼ぶ。
平衡状態において状態量に変化はないが、空間的分布にばらつきがある（系全体で値が一様でない）ことがふつう。

圧力・局所密度・配向秩序変数などの結晶構造を表す物理量を調べることは、緩和過程の様子・仕組みを解明する手掛かりになる。

## アンサンブル平均・MC・エルゴード仮説

統計力学では、ミクロな物理量の統計平均をとってマクロ平均値（アンサンブル平均）が計算される。E(n)は状態 n でのエネルギー。$e^{-\beta E(n)}$はボルツマン因子。P(n)は、あるミクロな状態 n が実現する確率分布である。

$$
\def \EXP { e^{-\beta E(n)} }

P(n) = \frac{\EXP}{\int \EXP dn} \\

\langle A \rangle = \int A(n)P(n) dn = \frac{\sum_n A_n \EXP}{\sum_n \EXP}

% \begin{align}
% \langle A \rangle &= \int A(n)P(n) dn \\
%   &= \frac{\sum_n A_n \EXP}{\sum_n \EXP}
% \end{align}
$$

モンテカルロ法（MC）は、ある特定のアンサンブルに対応する状態を上式に従うように M 個発生させ、以下のように物理量 A のアンサンブル平均とする。MC は確率論的モデルである。下の式は、アンサンブル平均（の近似）であって、時間平均ではない。

$$
\langle A \rangle = \frac{1}{M} (A(n_1) + A(n_2) + … + A(n_M))
$$

**MCMC（マルコフチェイン MC）**: 時刻 t にある動的変数をもつ遷移確率が時刻 t0 より前の状態に依存しない過程（＝＝マルコフ連鎖）を用いて、平衡確率分布 P(n)に従うようにサンプル分布 n_1,...n_M を得る手法である。
マルコフチェインにおいて、周期性を持たない＋どの状態からでも他の状態に到達できる（t1->t2 へ到達できる）場合、エルゴード的であると言う。エルゴード的な系では、アンサンブル平均が定常状態となるし、得られる分布が定常状態になるためにはエルゴード的である（ergodic Markov Chain）必要がある（必要十分）。

**エルゴード性（ergodicity）、エルゴード仮説**: 位相空間での平均は時間平均に等しいとする，統計力学における仮説。
統計力学において、実験では系の時間平均しかとれない。そこで、時間平均とアンサンブル平均が一致することを前提として考える（あくまで前提）。
MC では 1 つの軌道をサンプリングする。この軌道が系全体の相空間を十分サンプリングすること==エルゴード性が必要。エルゴード性がないと、標本が偏ってしまい、統計量が正しくならない。
エルゴード性は破れる場合がある。→ 特定の初期状態から出発した系が、相空間の一部に閉じ込められるような状況。例えば、ガラス状態、局在化現象(many-body localization)。

**MD（分子動力学法）**: エルゴード仮説を用いる。運動方程式を数値計算することで決定論的に値を出して、アンサンブル平均を長時間平均から計算する手法。MC は確率論的なもので平衡状態の静的性質のみ求められるが、MD は動的性質についても求められる。（MC でも ECMC で拡散係数を求めることはある。D.Mugita2024 など）

## 剛体球系について
hard sphere / disk. 球状分子間の引力を無視し、排除体積効果による反発力のみをもつ。ハードコア系。変形しない。
接触した際のみに反発力が生じる。そのため、衝突時以外は等速直線運動となる。

粒子半径内は無限体のポテンシャル、その外はポテンシャルゼロ。

剛体球系における相転移の有無は「剛体球問題」として統計物理で重要な問題。これに対し、MCやMDなどの分子シミュレーションという方法論が開発された。
剛体球系でのMD（EDMD）はAlderが開発し、固相ー液相感の1次相転移であるAlder転移の存在を示した。これは理論ではわからなかったものを電子計算機により解明した一例だ。
禁煙ではW.KrauthらがリジェクションフリーのECMCを開発した。ECMCは比較的シンプルなコードで、高効率である。EDMDやEMCMは剛体球系の平衡化（Equiribration）を高速に実現することが既にわかっている。

剛体球系の相転移：3dは一次転移。2dでは**長距離位置秩序**をもつ結晶の存在が否定され、2次元系の相転移は一般的な秩序-無秩序相転移（固相⇄液相など）ではないことが判明した(2次元融解問題)。ここで、ヘキサティック相が提唱された。
ヘキサティック相は，位置秩序は液相のように短距離相関。しかし、配向秩序はべき相関を持った準長距離相関。現在では，2dでの液相-固相間の相転移はヘキサティック相を経由する。液相-ヘキサティック相間の転移はMayer-Wood型1次転移，ヘキサティック相-固相間の転移はKosterlitz-Thousless (KT) 型連続転移である．

2成分ハードディスク系：これはガラスのモデルとして扱われる。
ガラス＝＝非晶質固体（晶質＝＝内部の原子配列の秩序性がある状態）。ガラスはアモルファスの一種。分子構造はLiquidのようにランダムだが、分子の運動はSolidのように遅い。液体を急冷すると結晶化することなく過冷却機体となり、ある温度以下でガラス状態となる。過冷却液体からガラス状態への相転移を「ガラス転移」。ガラスは、緩和時間τが発散している（イメージとしてはずっと動いてる感じ）。剛体球系においては、ガラスは2成分で高密度な場合に実現されると考えられている。
結晶化を防いでガラス化させるため、大小2種類の粒子を用いた2成分ソフトコア系（ある程度重なり合える、ハードコア系のような排除体積効果のみでない有限の粒子間ポテンシャルをとる系）で行うことが多い。ソフトコア系の制御パラメータは温度Tと粒子占有率ν。しかし、剛体球系では温度の概念がない。よって、系の制御パラメータはνのみ。

非平衡応答→非平衡状態において、外部からの摂動（小さな外部的変化や操作）に対してどのように応答するか。外部からの影響を受けて、その後にどのように系が時間発展していくか。

## Event-Driven　アルゴリズム：　EDMD,　ECMC, NEC
剛体球ポテンシャルでは、衝突時以外は等速直線運動する。よって、衝突というイベントごとに粒子を動かせば十分。イベント駆動型アルゴリズムでは、イベントごとに系を（時間）発展させていく。

### EDMD
MDならふつう、微小刻み時間で差分化して粒子の起動を逐次的に計算する。しかし剛体球系なら上記の理由でイベントを追跡するだけでよい。

最も基礎的には下記の通り。
1. 全粒子に初期条件（位置・速度）を与える
2. 全粒子対の衝突時間を計算する：t_1 ~ t_Nを得る
3. 最短衝突時間t_minをt_1 ~ t_Nから見つけて、最短で衝突する粒子i,jを見つける。
4. 全粒子をt_minだけ等速直線運動させる。
5. 粒子i,jの衝突後の速度をニュートン則から計算する
6. 2-5を繰り返す。

このナイーブな方法では1collisionにO(N^2)かかる。（O(1) event listのアルゴリズムも現在はある。現在の剛体球系のEDMD最速アルゴリズムはN.Murase？）

粒子同士の衝突での速度変化にはニュートン則。剛体円盤同士の衝突は弾性衝突(e=1)となる。同じ質量なら、結果的にこうなる。

$$
\begin{align}
   \bold{v'_i} &= \bold{v_i} - [\bold{v_{ij}} \cdot \bold{n}] \bold{n} \\
      &= \bold{v_i} - \frac{b}{\sigma_{ij}^2} \bold{r_{ij}} \\

    \bold{v'_j} &= \bold{v_j} + \frac{b}{\sigma_{ij}^2} \bold{r_{ij}}
\end{align}
$$

$$
variables: \\
\begin{align}
\bold{v_{ij}} &= \bold{v_i} - \bold{v_j} \\
\bold{r_{ij}} &= \bold{r_i} - \bold{r_j} \\
b &= \bold{v_{ij}} \cdot \bold{r_{ij}} \\
\sigma_{ij} &= \sigma_i + \sigma_j = (iの半径) + (jの半径) \\
\bold{n} &= \frac{\bold{r_{ij}}}{|\bold{r_{ij}}|} = (衝突面の法線ベクトル) \\
\end{align}
$$

### ECMC
MC（MCMC）ではふつう、乱数で移動させてオーバーラップが生じたらその試行をリジェクトする。一方ECMCでは、アクティブ粒子（変位を行う粒子）は他粒子と衝突するまで変位し、衝突された粒子が次のアクティブ粒子になる。これによりリジェクションフリーでのMCを実現している。衝突ごとに系を発展させるため、これはEvent Drivenである。

ECMCの基となっている考え：変位試行ベクトルΔxの大きさδを無限小にして、一定方向の無限回の試行を行えば、衝突するまでの全ての試行がアクセプトされる。（ここではハード系を扱っているので、衝突のみをイベントとして扱えば良い。しかし、ソフト系では小さな変位を重ねる必要がある）

基本的に、試行がある条件に達したら、再度全粒子からランダムにアクティブ粒子を選ぶ。粒子のランダム選択から次のランダム選択までの繰り返しにより生じる粒子衝突の連鎖のことをイベント鎖（Event-Chain）と呼ぶ。このイベント鎖の長さ$L_c$をイベント鎖長という。

ECMCには、衝突後の変位の向きの決め方によって幾つか種類がある。

アルゴリズム：
1. 全粒子からランダムにアクティブ粒子iを選び、そのイベント鎖での変位の向きを決定する（ずっと+xとか）。
2. 別の粒子jと衝突するまでアクティブ粒子iを変位させる
3. jをアクティブ粒子にする
4. 2~3を繰り返し、粒子変位の和がある値Lcに達したら1に戻る

#### 例）SEC（Straight ECMC）
直線イベント鎖モンテカルロ法。ECMCで最も単純で、変位の向きを「ずっとθ=60°方向」「ずっと+x方向」のようにする。
一般的には、ECMCといえばSECを指すことが多い。変位を+x,+y (+z)方向のみにした方法はSEC-xy（ECMC-xy）、全方向からランダムに向きを決める手法をSEC-all（ECMC-all）と呼ぶことが多い。

SEC-xyの場合、不可逆MCとなる（時間的に不可逆）。
MCで可逆であるとは「逆遷移が同じ確率で可能」であること。$P(X\rightarrow Y) = P(Y\rightarrow X)$

**time-reversal symmetry, TRS (時間反転対称性)**: ある物理過程において、$t \rightarrow -t$した時に物理法則や運動方程式の形式が変わらなければTRSを持つ。
確率遷移としては、$P(X(t+\Delta t)|X(t)) = P(X(t-\Delta t)|X(t))$ならTRSを持つ。
たとえばエントロピー増大則は時間の一方向性を示すものなので、TRSの破れがある（微視的にはTRSを持ち、統計的にはTRSが破れている）。

つまりSEC-xyが不可逆MCであるのは、一方向性（xで+xのみ、yで+yのみ）を持ち、時間反転した時に-x, -yとならないから。（そのイベントチェーンでx方向に変位するときに+x,-x方向のいずれかを等確率で選ぶのなら、TRSは保たれる。）

#### Detailed Balance と Global Balance
TRSに関連して、DB（詳細釣り合い）とGB（全体釣り合い）も触れる。

$$
% ~ で半角スペース。\quadで1emスペース。
\begin{align}
&DB ~ rule: \pi(x) P(x \rightarrow y) = \pi(y) P(y \rightarrow x) \\
&GB ~ rule: \sum_{y}{\pi(y) P(y \rightarrow x)} = \pi(x)
\end{align}
$$

π(x)は、状態xの平衡分布（ボルツマン分布など）

DB: 状態xとyの間で、行きと帰りの遷移確率が揃っている。TRSが成り立つ。
GB: 各状態の確率流の出入りが揃っている。（上式では、状態xへ至る全ての遷移の確率の和が、xの平衡分布となっている）

例えばMetropilis法 $P(x \rightarrow y) = \min(1, \frac{\pi(y)}{\pi(x)})$ では、DBが満たされている（よってGBは満たされる）。
例えばECMC-xでは、DBは破れているが、GBは成り立っている。（DB ruleは$\pi(x) \cdot 1 = \pi(y) \cdot 0$となり一般には成り立たない。）

DBは正しい平衡分布の十分条件であり、GBは正しい平衡分布の必要条件である。
可逆なものに対して少しでも可逆性を破ると、分布の収束は必ず速くなることが証明されている


### NEC
ECMCの発展版。性質がECMCとは異なるため注意。
効率的な平衡化のために、ニュートン力学的要素として、初期化時に粒子に速度ベクトルを与える（Maxwell-Boltzmann分布が多い）。変位の向きは各粒子の速度ベクトルに従い、衝突時には衝突則を適用。イベント鎖長には単位を時間としてTcを用いる。

イベントチェーンの単位に長さLcを用いると、遅い/速い粒子を多く含むイベントチェーンでは刑の時間の進む早さが異なってしまう。なのでNECではTcが適切。

NECは、剛体球系での平衡系における拡散係数，核生成率，および融解過程の平衡状態に達するまでの効率において，EDMDやECMCを上回ることがわかっている．
また，NECは再始動なしでも系を平衡緩和させることができる．ただし，再始動なしで必ず全ての系を平衡緩和させられるわけではない．再始動なし（Tc->∞）とする場合が，最も拡散効率が高くなる例もある（D.Mugita 2024）．

:::details 衝突時の速度更新コード例（Golang）
今回はGonumを使うと、圧倒的に遅くなった。（3次元ベクトル）
理由は、BLAS/LAPACKは小さい行列・ベクトルの場合はオーバーヘッドの方が大きくなるから？また、Gonumが巨大なパッケージであるために生じるオーバーヘッドもある？

テストの結果: 下記の純粋なGoで60ns/op, gonum/matのVecDenseで(ある程度メモリ割り当てを節約しても) 370ns/opだった。(Macbook m2, メモリ16GB, CPU 8core, GPU未使用)

粒子数を512^2、1粒子がアクティブになった平均回数が10^7になるまでやるとすると、1シミュレーションで$310ns * 10^{-9} * (512^2 * 10^7) \sim 8.6 * 10^5s \sim 240h = 10day$の違いになる。
```go
// obj/particle.go
package obj

import (
 "fmt"

 "github.com/masa0902dev/purego-harddisk-sim/util"
)

type Particle struct {
 ID     int
 Pos    *[]float64
 Vel    *[]float64
 Radius float64
}

// pi: collider, pj: collidee
func UpdateColVel(pi, pj *Particle) {
 rij := util.Vecsub(*pi.Pos, *pj.Pos)
 vij := util.Vecsub(*pi.Vel, *pj.Vel)
 b := util.Vecdot(vij, rij)

 sigma := pi.Radius + pj.Radius
 scale := b / sigma
 diff := util.Vecscale(rij, scale)

 util.VecsubP(pi.Vel, diff)
 util.VecaddP(pj.Vel, diff)
}

func LogParticle(p *Particle) {
 fmt.Printf("------ ID: %v ------\n", p.ID)
 fmt.Printf("Pos: %v\n", p.Pos)
 fmt.Printf("Vel: %v\n", p.Vel)
 fmt.Printf("Radius: %v\n", p.Radius)
}

```

```go
// util/vector.go
package util

func Vecsub(a, b []float64) []float64 {
 sub := make([]float64, len(a))
 for i := range a {
  sub[i] = a[i] - b[i]
 }
 return sub
}
func VecsubP(a *[]float64, b []float64) {
 for i := range *a {
  (*a)[i] -= b[i]
 }
}

func Vecadd(a, b []float64) []float64 {
 add := make([]float64, len(a))
 for i := range a {
  add[i] = a[i] + b[i]
 }
 return add
}
func VecaddP(a *[]float64, b []float64) {
 for i := range *a {
  (*a)[i] += b[i]
 }
}

func Vecdot(a, b []float64) float64 {
 dot := 0.0
 for i := range a {
  dot += a[i] * b[i]
 }
 return dot
}

func Vecscale(a []float64, s float64) []float64 {
 scaled := make([]float64, len(a))
 for i := range a {
  scaled[i] = a[i] * s
 }
 return scaled
}

```
:::


## PBC: 周期境界条件
periodic boundary condition.
そもそもPBCを用いるモチベーションは，シミュレーションで現実的に扱える粒子数が現実世界よりも非常に小さいことに起因する．現実並みに多くの粒子（アボガドロ数6.0*10^23個のオーダー）を扱えるのなら，表面効果（系が壁面で囲まれている場合に生じる，壁面が周囲粒子に影響して結果的に粒子全体に力を与える現象）は十分小さいので無視してもよい場合が多い．しかしその粒子数は現実的でないため，表面効果の影響が大きくなってしまう．そこで，表面効果の影響を小さくするためPBCを用いる．

RES: PBCを用いた場合・動かない剛体壁を用いた場合で，どのくらい物理量に差がでる？システムサイズにどのくらい依存する？表面効果の影響度の大きさはN^{-1}に比例かな？

少ない粒子数で大きな系の物性を近似する手法．着目している系内の粒子数は常に保存される．


## MSD, D
mean square displacement: 平均二乗変位．粒子の拡散度合いを表す．

$$
MSD = \frac{1}{N} \sum_{i=1}^{N} |\bold{r_i}(t) - \bold{r_i}(0)|^2 = \langle |\bold{r_i}(t) - \bold{r_i}(0)|^2 \rangle
$$

**時間tが小さい時は$MSD \propto t^2$となる．**
なぜなら…tが小さい時で粒子変位$r_i(t) - r_i(0)$をマクローリン展開すれば$v_i(0) t$に近似でき，エネルギー等分配則$\frac{\ddot{d}}{2} k_b T = \frac{1}{2} m \langle v^2 \rangle$を用いて式変形すれば，$\langle |\bold{r_i}(t) - \bold{r_i}(0)|^2 \rangle \approx \langle |\bold{v}(t)|^2 \rangle t^2 = \frac{\ddot{d} k_b T}{m} t^2$を得るから．
ただし，$\ddot{d}$は次元，$k_b$はボルツマン定数．

**次に，時間tが大きい場合は$MSD \propto t$となる．**
なぜなら…（省略．拡散方程式 $\frac{\partial P(x,t)}{\partial t} = D \frac{\partial^2 P(x, t)}{\partial x^2}$ を変形・条件付けすると最終的に $\langle x^2(t) \rangle = 2Dt$が得られて，これを$\ddot{d}$次元へ拡張すると $\langle |\bold{r}(t) - \bold{r}(0)|^2 \rangle = 2 \ddot{d} D t$が得られるから．）
Dは拡散係数(diffusion coefficient)であり，大きいほど粒子は拡散していると見做せる．


## 配向秩序変数
orientational order parameter

（そもそも，）order parameter: 秩序変数．相の秩序状態を表す．秩序-無秩序相転移を調べるためによく使われる．0~1の値を取り，1に近いほど系に秩序がみられる・0に近いほど系に秩序が見られないと設定されることが多い．

秩序状態：例えば，粒子が格子状にならぶ，粒子の向きやスピンが揃っている，粒子の密度が周期的，などなどの空間的・構造的な規則性，対称性のこと．
位置秩序，配向秩序（粒子の向き・スピンが揃っている），トポロジカル秩序（幾何的には無秩序でもトポロジー的特徴がある），時間的秩序（時間的な周期や構造がある）などがある．

配向秩序変数は，結晶の回転対称性に関する値．系の液相-結晶相 間の相転移の性質を知れる．
粒子iについての**ミクロな**配向秩序変数は下記．（ローカル・グローバル配向秩序変数の元になる）

$$
\phi_6^i = \frac{1}{N_i} \sum_{j=1}^{N_i} \exp{(6 \mathrm{i} \theta_i^j)}
$$

実際に値として評価する際には，その大きさ$|\phi_6^i|$で評価する．大きさが一に近いほど

$$
|\phi_6^i| = \sqrt{|\phi_6^i|^2} = \sqrt{\phi_6^i \cdot \phi_6^{i*}} = \sqrt{a_i^2 + b_i^2}
$$
